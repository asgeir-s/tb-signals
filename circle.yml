machine:
  python:
    version: 2.7.3
  services:
    - docker
  environment:
      THE_BRIDGE_IP: $(/sbin/ip route|awk '/default/ { print $3 }')
      AWS_DEFAULT_REGION: us-west-2
      RDS_HOSTNAME: 172.17.42.1

dependencies:
  pre:
    - wget -q https://dl.bintray.com/sbt/debian/sbt-0.13.8.deb
    - sudo dpkg -i sbt-0.13.8.deb
    - pip install awscli
  cache_directories:
    - "~/.ivy2"
    - "~/.sbt"
  override:
    - chmod 777 sh/deploy.sh
    - echo $THE_BRIDGE_IP
    - docker info
    - make build

test:
  pre:
    - sudo bash -c "echo \"listen_addresses = '*'\" >>
      /etc/postgresql/9.4/main/postgresql.conf"
    - sudo bash -c "echo \"host all all 0.0.0.0/0 trust\" >>
      /etc/postgresql/9.4/main/pg_hba.conf"
    - sudo /etc/init.d/postgresql restart
    - make setup-db
  override:
    # 172.17.42.1 should be equal to THE_BRIDGE_IP
    - make test-u
    - make test-s

deployment:
  elasticbeanstalk:
    branch: master
    commands:
      - ./sh/deploy.sh $CIRCLE_SHA1